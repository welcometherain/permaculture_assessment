<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Permaculture Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Loading Google Maps API synchronously to ensure it's available -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuFONHLyXGalqEH9VL3oFl8MpHgF7sa5k&libraries=places"></script>
    <style>
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .dark {
            background-color: #181818;
            color: #e2e8f0;
        }
        #sunpath-diagram {
            width: 100%;
            height: 200px;
        }
        #climate-chart {
            max-width: 100%;
            height: 250px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="loading-indicator" class="hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-800">Loading data...</p>
            <button id="cancel-loading" class="mt-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Cancel Loading</button>
        </div>
    </div>

    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <h1 class="text-2xl font-bold text-gray-900">Simplified Permaculture Analysis</h1>
            <p class="text-gray-600">Map, Climate Data, and Sun Analysis</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Map Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Select Your Location</h2>
            
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <input id="address-input" type="text" placeholder="Enter an address" class="w-full px-4 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="search-button" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Search</button>
                <button id="use-location-button" class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">Use My Location</button>
            </div>
            
            <div id="map-container" class="h-96 rounded-lg overflow-hidden border border-gray-300"></div>
            
            <div class="mt-4">
                <p id="selected-location" class="text-gray-600">No location selected. Please search or click on the map.</p>
            </div>
        </div>

        <!-- Climate Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div id="climate-section" class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Climate History (30-Year)</h2>
                <div>
                    <canvas id="climate-chart"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <h3 class="font-medium text-gray-700">Annual Rainfall</h3>
                        <p id="avg-rainfall" class="text-2xl font-bold text-blue-600">--</p>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-700">Temperature Range</h3>
                        <p id="temp-range" class="text-2xl font-bold text-blue-600">--</p>
                    </div>
                </div>
            </div>

            <!-- Sun Path Section -->
            <div id="sunpath-section" class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Sun Path Analysis</h2>
                <div id="sunpath-diagram" class="bg-gray-200 rounded-lg relative overflow-hidden">
                    <!-- Sun path visualization will go here -->
                </div>
                <div class="mt-4">
                    <label for="date-select" class="block text-gray-700 mb-2">Select Date:</label>
                    <select id="date-select" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                        <option value="0321">March 21 (Spring Equinox)</option>
                        <option value="0621">June 21 (Summer Solstice)</option>
                        <option value="0921">September 21 (Fall Equinox)</option>
                        <option value="1221">December 21 (Winter Solstice)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-200 p-4 rounded-lg mb-6">
            <h3 class="font-medium text-gray-800">Debug Information</h3>
            <div id="debug-info" class="text-sm text-gray-600 mt-2">
                Application initialized. Waiting for user input.
            </div>
        </div>
    </main>
    
    <script>
        // Utility function to log and show debug info
        function debugLog(message) {
            console.log(message);
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = message + '<br>' + debugInfo.innerHTML;
        }
        
        // Cancel loading button
        document.getElementById('cancel-loading').addEventListener('click', function() {
            document.getElementById('loading-indicator').classList.add('hidden');
            debugLog('Loading cancelled by user');
        });

        // Global variables
        let map;
        let marker;
        let geocoder;
        let selectedLocation = null;
        let climateChart = null;
        
        // Initialize map
        function initMap() {
            try {
                debugLog('Initializing map...');
                
                // Default location (San Francisco)
                const defaultLocation = { lat: 37.7749, lng: -122.4194 };
                
                // Create map
                map = new google.maps.Map(document.getElementById('map-container'), {
                    center: defaultLocation,
                    zoom: 12,
                    mapTypeId: 'terrain',
                    mapTypeControl: true
                });
                
                debugLog('Map created successfully');
                
                // Create geocoder
                geocoder = new google.maps.Geocoder();
                
                // Add click event to map
                map.addListener('click', function(event) {
                    debugLog('Map clicked at: ' + event.latLng.toString());
                    placeMarker(event.latLng);
                    updateSelectedLocation(event.latLng);
                    loadSiteData(event.latLng);
                });
                
                // Initialize the search box
                const input = document.getElementById('address-input');
                const searchBox = new google.maps.places.SearchBox(input);
                
                // Bias the SearchBox results towards current map's viewport
                map.addListener('bounds_changed', function() {
                    searchBox.setBounds(map.getBounds());
                });
                
                // Listen for the event fired when the user selects a prediction
                searchBox.addListener('places_changed', function() {
                    const places = searchBox.getPlaces();
                    
                    if (places.length === 0) {
                        debugLog('No places found');
                        return;
                    }
                    
                    const place = places[0];
                    
                    if (!place.geometry || !place.geometry.location) {
                        debugLog('Returned place contains no geometry');
                        return;
                    }
                    
                    debugLog('Place found: ' + place.name);
                    
                    // Set map view to the selected place
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    
                    // Place marker
                    placeMarker(place.geometry.location);
                    updateSelectedLocation(place.geometry.location);
                    loadSiteData(place.geometry.location);
                });
                
                // Search button click handler
                document.getElementById('search-button').addEventListener('click', function() {
                    const address = document.getElementById('address-input').value;
                    debugLog('Searching for address: ' + address);
                    
                    if (address) {
                        geocoder.geocode({ 'address': address }, function(results, status) {
                            if (status === 'OK') {
                                debugLog('Address found: ' + results[0].formatted_address);
                                map.setCenter(results[0].geometry.location);
                                map.setZoom(15);
                                placeMarker(results[0].geometry.location);
                                updateSelectedLocation(results[0].geometry.location);
                                loadSiteData(results[0].geometry.location);
                            } else {
                                debugLog('Geocode was not successful: ' + status);
                                alert('Geocode was not successful for the following reason: ' + status);
                            }
                        });
                    }
                });
                
                // Use my location button click handler
                document.getElementById('use-location-button').addEventListener('click', function() {
                    debugLog('Requesting user location...');
                    
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            debugLog('User location found: ' + pos.lat + ', ' + pos.lng);
                            
                            map.setCenter(pos);
                            map.setZoom(15);
                            placeMarker(pos);
                            updateSelectedLocation(pos);
                            loadSiteData(pos);
                        }, function(error) {
                            debugLog('Geolocation error: ' + error.message);
                            alert('Error: The Geolocation service failed. Error: ' + error.message);
                        });
                    } else {
                        debugLog('Geolocation not supported by browser');
                        alert('Error: Your browser doesn\'t support geolocation.');
                    }
                });
                
                // Date selection change handler for sun path
                document.getElementById('date-select').addEventListener('change', function() {
                    debugLog('Date changed to: ' + this.value);
                    
                    if (selectedLocation) {
                        updateSunPath(selectedLocation, this.value);
                    }
                });
                
                // Show default data for San Francisco
                debugLog('Loading default data for San Francisco');
                placeMarker(defaultLocation);
                updateSelectedLocation(defaultLocation);
                loadSiteData(defaultLocation);
                
            } catch (error) {
                debugLog('ERROR initializing map: ' + error.message);
                console.error('Map initialization error:', error);
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }
        
        // Function to place marker on map
        function placeMarker(location) {
            try {
                if (marker) {
                    marker.setMap(null);
                }
                
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    animation: google.maps.Animation.DROP
                });
                
                debugLog('Marker placed at: ' + location.toString());
            } catch (error) {
                debugLog('ERROR placing marker: ' + error.message);
            }
        }
        
        // Function to update selected location display
        function updateSelectedLocation(location) {
            try {
                selectedLocation = location;
                
                // Simple direct coordinate display as backup
                const coordsText = `Selected Location: (${location.lat().toFixed(5)}, ${location.lng().toFixed(5)})`;
                document.getElementById('selected-location').textContent = coordsText;
                
                // Try to get address via reverse geocoding
                geocoder.geocode({ 'location': location }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('selected-location').textContent = 
                            `Selected Location: ${results[0].formatted_address}`;
                        debugLog('Address found: ' + results[0].formatted_address);
                    }
                });
            } catch (error) {
                debugLog('ERROR updating location: ' + error.message);
            }
        }
        
        // Function to load site data
        function loadSiteData(location) {
            try {
                // Show loading indicator
                document.getElementById('loading-indicator').classList.remove('hidden');
                debugLog('Loading data for location: ' + location.toString());
                
                // Ensure loading completes eventually
                const loadingTimeout = setTimeout(() => {
                    document.getElementById('loading-indicator').classList.add('hidden');
                    debugLog('Loading timeout triggered - forcing completion');
                }, 10000);
                
                // Update climate data
                updateClimateData(location);
                
                // Update sun path
                updateSunPath(location, document.getElementById('date-select').value);
                
                // Hide loading indicator
                document.getElementById('loading-indicator').classList.add('hidden');
                clearTimeout(loadingTimeout);
                debugLog('Data loading complete');
            } catch (error) {
                document.getElementById('loading-indicator').classList.add('hidden');
                debugLog('ERROR loading data: ' + error.message);
            }
        }
        
        // Function to update climate data
        function updateClimateData(location) {
            try {
                debugLog('Updating climate data...');
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Generate climate data based on location
                const lat = location.lat();
                const lng = location.lng();
                
                // Adjust temperatures based on latitude
                const tempOffset = (Math.abs(lat) - 30) * 0.5;
                
                // Generate high and low temperatures with seasonal variation
                const highTemps = months.map((_, index) => {
                    const seasonalFactor = Math.sin((index / 12) * 2 * Math.PI);
                    return Math.round(25 - tempOffset + seasonalFactor * (15 - lat * 0.1));
                });
                
                const lowTemps = months.map((_, index) => {
                    const seasonalFactor = Math.sin((index / 12) * 2 * Math.PI);
                    return Math.round(15 - tempOffset + seasonalFactor * (10 - lat * 0.1));
                });
                
                // Generate rainfall data with appropriate patterns
                const isWesternHemisphere = lng < 0;
                const rainfall = months.map((_, index) => {
                    let seasonalFactor;
                    
                    if (isWesternHemisphere) {
                        seasonalFactor = lat > 0 
                            ? Math.cos((index / 12) * 2 * Math.PI)  // Northern hemisphere
                            : -Math.cos((index / 12) * 2 * Math.PI); // Southern hemisphere
                    } else {
                        seasonalFactor = lat > 0 
                            ? Math.sin((index / 12) * 2 * Math.PI)  // Northern hemisphere
                            : -Math.sin((index / 12) * 2 * Math.PI); // Southern hemisphere
                    }
                    
                    return Math.max(5, Math.round(50 + seasonalFactor * 30 + Math.random() * 20));
                });
                
                // Update chart
                if (climateChart) {
                    climateChart.destroy();
                }
                
                debugLog('Creating climate chart...');
                const ctx = document.getElementById('climate-chart').getContext('2d');
                
                climateChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'High Temp (°C)',
                                data: highTemps,
                                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                type: 'line',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Low Temp (°C)',
                                data: lowTemps,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                type: 'line',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Rainfall (mm)',
                                data: rainfall,
                                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                borderWidth: 1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Rainfall (mm)'
                                }
                            }
                        }
                    }
                });
                
                // Update summary data
                const totalRainfall = rainfall.reduce((sum, val) => sum + val, 0);
                document.getElementById('avg-rainfall').textContent = `${Math.round(totalRainfall)} mm/year`;
                
                const minTemp = Math.min(...lowTemps);
                const maxTemp = Math.max(...highTemps);
                document.getElementById('temp-range').textContent = `${minTemp}°C to ${maxTemp}°C`;
                
                debugLog('Climate data updated successfully');
            } catch (error) {
                debugLog('ERROR updating climate data: ' + error.message);
            }
        }
        
        // Function to update sun path
        function updateSunPath(location, dateCode) {
            try {
                debugLog('Updating sun path diagram...');
                const sunpathDiagram = document.getElementById('sunpath-diagram');
                
                // Set canvas dimensions explicitly
                sunpathDiagram.width = sunpathDiagram.offsetWidth;
                sunpathDiagram.height = sunpathDiagram.offsetHeight;
                
                const ctx = sunpathDiagram.getContext('2d');
                
                // Clear the canvas
                ctx.clearRect(0, 0, sunpathDiagram.width, sunpathDiagram.height);
                
                // Set up dimensions and coordinates
                const width = sunpathDiagram.width;
                const height = sunpathDiagram.height;
                const centerX = width / 2;
                const centerY = height * 0.7; // Lower the horizon to show more sky
                const radius = Math.min(width, height) * 0.4;
                
                // Draw horizon line
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(width, centerY);
                ctx.strokeStyle = '#888';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Draw compass points
                const compassPoints = [
                    { label: 'N', angle: 0 },
                    { label: 'E', angle: Math.PI * 0.5 },
                    { label: 'S', angle: Math.PI },
                    { label: 'W', angle: Math.PI * 1.5 }
                ];
                
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#333';
                
                compassPoints.forEach(point => {
                    const x = centerX + Math.sin(point.angle) * (radius + 20);
                    const y = centerY - Math.cos(point.angle) * (radius + 20);
                    ctx.fillText(point.label, x, y);
                });
                
                // Calculate sun path for the selected date
                let season = 'winter';
                if (dateCode === '0321' || dateCode === '0921') {
                    season = 'equinox';
                } else if (dateCode === '0621') {
                    season = 'summer';
                }
                
                // Adjust path based on latitude
                const latitude = location.lat();
                const isNorthernHemisphere = latitude >= 0;
                let maxAltitude;
                
                if (season === 'winter') {
                    maxAltitude = Math.max(0.1, 0.5 - Math.abs(latitude) / 90);
                    if (!isNorthernHemisphere) maxAltitude = 0.8 - maxAltitude;
                } else if (season === 'equinox') {
                    maxAltitude = 0.5;
                } else { // summer
                    maxAltitude = Math.min(0.9, 0.5 + Math.abs(latitude) / 90);
                    if (!isNorthernHemisphere) maxAltitude = 0.8 - maxAltitude;
                }
                
                // Draw sun path arc
                ctx.beginPath();
                for (let angle = -Math.PI; angle <= 0; angle += 0.01) {
                    const x = centerX + Math.sin(angle) * radius;
                    const y = centerY - Math.cos(angle) * radius * maxAltitude;
                    
                    if (angle === -Math.PI) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.strokeStyle = '#ff6600';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Draw sun positions at different times
                const sunPositions = [
                    { time: 'Sunrise', angle: -Math.PI },
                    { time: '10:00', angle: -Math.PI * 0.75 },
                    { time: 'Noon', angle: -Math.PI * 0.5 },
                    { time: '15:00', angle: -Math.PI * 0.25 },
                    { time: 'Sunset', angle: 0 }
                ];
                
                sunPositions.forEach(pos => {
                    const x = centerX + Math.sin(pos.angle) * radius;
                    const y = centerY - Math.cos(pos.angle) * radius * maxAltitude;
                    
                    // Draw sun
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffaa00';
                    ctx.fill();
                    
                    // Draw time label
                    ctx.fillStyle = '#333';
                    ctx.fillText(pos.time, x, y + 20);
                });
                
                debugLog('Sun path updated successfully');
            } catch (error) {
                debugLog('ERROR updating sun path: ' + error.message);
            }
        }
        
        // Initialize the app when page loads
        window.onload = function() {
            debugLog('Page loaded, initializing application...');
            
            // Check if Google Maps is available
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                debugLog('ERROR: Google Maps API not loaded');
                alert('Google Maps API failed to load. Please check your internet connection and try again.');
                return;
            }
            
            // Initialize map after a short delay
            setTimeout(initMap, 200);
        };
    </script>
</body>
</html>
