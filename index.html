<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Permaculture Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuFONHLyXGalqEH9VL3oFl8MpHgF7sa5k&libraries=places" async defer></script>
    <style>
        /* Dark mode support */
        .dark {
            background-color: #181818;
            color: #e2e8f0;
        }
        .dark .card {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        #sunpath-diagram {
            width: 100%;
            height: 200px;
            position: relative;
        }
        #climate-chart {
            max-width: 100%;
            height: 250px;
        }
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
    <script>
        // Configure Tailwind for dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                },
            },
        }
        
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div id="loading-indicator" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mx-auto"></div>
            <p class="mt-4 text-gray-800 dark:text-gray-200">Loading site data...</p>
        </div>
    </div>

    <header class="bg-white dark:bg-gray-800 shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                Simple Permaculture Site Analysis
            </h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Map Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Select Your Location</h2>
            
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <input id="address-input" type="text" placeholder="Enter an address" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <button id="search-button" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition">Search</button>
                <button id="use-location-button" class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-opacity-90 transition">Use My Location</button>
            </div>
            
            <div id="map-container" class="h-96 rounded-lg overflow-hidden"></div>
            
            <div class="mt-4">
                <p id="selected-location" class="text-gray-600 dark:text-gray-300">No location selected. Please search or click on the map.</p>
            </div>
        </div>

        <!-- Climate Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">
                Climate History (30-Year)
            </h2>
            <div>
                <canvas id="climate-chart"></canvas>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div>
                    <h3 class="font-medium text-gray-700 dark:text-gray-300">Average Annual Rainfall</h3>
                    <p id="avg-rainfall" class="text-2xl font-bold text-primary">--</p>
                </div>
                <div>
                    <h3 class="font-medium text-gray-700 dark:text-gray-300">Temperature Range</h3>
                    <p id="temp-range" class="text-2xl font-bold text-primary">--</p>
                </div>
            </div>
        </div>

        <!-- Sun Path Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">
                Sun Path Analysis
            </h2>
            <div id="sunpath-diagram" class="bg-gray-200 dark:bg-gray-700 rounded-lg relative overflow-hidden">
                <!-- Sun path visualization will go here -->
            </div>
            <div class="mt-4">
                <label for="date-select" class="block text-gray-700 dark:text-gray-300 mb-2">Select Date:</label>
                <select id="date-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700 dark:text-white">
                    <option value="0321">March 21 (Spring Equinox)</option>
                    <option value="0621">June 21 (Summer Solstice)</option>
                    <option value="0921">September 21 (Fall Equinox)</option>
                    <option value="1221">December 21 (Winter Solstice)</option>
                </select>
            </div>
        </div>
    </main>
    
    <script>
        // Global variables
        let map;
        let marker;
        let geocoder;
        let selectedLocation = null;
        let climateChart = null;
        
        // Force hide loading indicator after timeout
        function ensureLoadingCompletes() {
            setTimeout(() => {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (!loadingIndicator.classList.contains('hidden')) {
                    console.log('Forcing loading indicator to hide after timeout');
                    loadingIndicator.classList.add('hidden');
                }
            }, 5000);
        }
        
        // Initialize map
        function initMap() {
            try {
                console.log('Initializing Google Map');
                
                // Default location (San Francisco)
                const defaultLocation = { lat: 37.7749, lng: -122.4194 };
                
                // Create map
                map = new google.maps.Map(document.getElementById('map-container'), {
                    center: defaultLocation,
                    zoom: 12,
                    mapTypeId: 'terrain'
                });
                
                // Create geocoder
                geocoder = new google.maps.Geocoder();
                
                // Add click event to map
                map.addListener('click', function(event) {
                    console.log('Map clicked:', event.latLng.toString());
                    placeMarker(event.latLng);
                    updateSelectedLocation(event.latLng);
                    loadSiteData(event.latLng);
                });
                
                // Initialize the search box
                const input = document.getElementById('address-input');
                const searchBox = new google.maps.places.SearchBox(input);
                
                // Bias the SearchBox results towards current map's viewport
                map.addListener('bounds_changed', function() {
                    searchBox.setBounds(map.getBounds());
                });
                
                // Listen for the event fired when the user selects a prediction
                searchBox.addListener('places_changed', function() {
                    const places = searchBox.getPlaces();
                    
                    if (places.length === 0) {
                        return;
                    }
                    
                    const place = places[0];
                    
                    if (!place.geometry || !place.geometry.location) {
                        console.log("Returned place contains no geometry");
                        return;
                    }
                    
                    // Set map view to the selected place
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    
                    // Place marker
                    placeMarker(place.geometry.location);
                    updateSelectedLocation(place.geometry.location);
                    loadSiteData(place.geometry.location);
                });
                
                // Search button click handler
                document.getElementById('search-button').addEventListener('click', function() {
                    const address = document.getElementById('address-input').value;
                    if (address) {
                        geocoder.geocode({ 'address': address }, function(results, status) {
                            if (status === 'OK') {
                                map.setCenter(results[0].geometry.location);
                                map.setZoom(15);
                                placeMarker(results[0].geometry.location);
                                updateSelectedLocation(results[0].geometry.location);
                                loadSiteData(results[0].geometry.location);
                            } else {
                                alert('Geocode was not successful for the following reason: ' + status);
                            }
                        });
                    }
                });
                
                // Use my location button click handler
                document.getElementById('use-location-button').addEventListener('click', function() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            map.setCenter(pos);
                            map.setZoom(15);
                            placeMarker(pos);
                            updateSelectedLocation(pos);
                            loadSiteData(pos);
                        }, function() {
                            alert('Error: The Geolocation service failed.');
                        });
                    } else {
                        alert('Error: Your browser doesn\'t support geolocation.');
                    }
                });
                
                // Date selection change handler for sun path
                document.getElementById('date-select').addEventListener('change', function() {
                    if (selectedLocation) {
                        updateSunPath(selectedLocation, this.value);
                    }
                });
                
                // Set up a default location
                placeMarker(defaultLocation);
                updateSelectedLocation(defaultLocation);
                loadSiteData(defaultLocation);
                
                console.log('Map initialization complete');
            } catch (error) {
                console.error('Error initializing map:', error);
                document.getElementById('loading-indicator').classList.add('hidden');
                alert('Error initializing map. Please check console for details.');
            }
        }
        
        // Function to place marker on map
        function placeMarker(location) {
            try {
                if (marker) {
                    marker.setMap(null);
                }
                
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    animation: google.maps.Animation.DROP
                });
            } catch (error) {
                console.error('Error placing marker:', error);
            }
        }
        
        // Function to update selected location display
        function updateSelectedLocation(location) {
            selectedLocation = location;
            
            try {
                // Display coordinates while geocoding
                document.getElementById('selected-location').textContent = 
                    `Selected Location: (${location.lat().toFixed(5)}, ${location.lng().toFixed(5)})`;
                
                // Reverse geocode to get address
                geocoder.geocode({ 'location': location }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('selected-location').textContent = 
                            `Selected Location: ${results[0].formatted_address}`;
                    }
                });
            } catch (error) {
                console.error('Error updating location display:', error);
            }
        }
        
        // Function to load site data
        function loadSiteData(location) {
            // Show loading indicator
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            // Set a safety timeout to hide the loading indicator
            ensureLoadingCompletes();
            
            try {
                console.log('Loading data for location:', location.toString());
                
                // Update climate data
                updateClimateData(location);
                
                // Update sun path
                updateSunPath(location, document.getElementById('date-select').value);
                
                // Hide loading indicator
                document.getElementById('loading-indicator').classList.add('hidden');
            } catch (error) {
                console.error('Error loading site data:', error);
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }
        
        // Function to update climate data
        function updateClimateData(location) {
            try {
                console.log('Updating climate data');
                // Simulate climate data - in reality, this would come from an API
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Generate random temperature data based on location
                // Using latitude to simulate seasonal variations
                const lat = location.lat();
                const tempOffset = (Math.abs(lat) - 30) * 0.5; // Adjust temperatures based on latitude
                
                const highTemps = months.map((_, index) => {
                    const seasonalFactor = Math.sin((index / 12) * 2 * Math.PI);
                    return Math.round(25 - tempOffset + seasonalFactor * (15 - lat * 0.1));
                });
                
                const lowTemps = months.map((_, index) => {
                    const seasonalFactor = Math.sin((index / 12) * 2 * Math.PI);
                    return Math.round(15 - tempOffset + seasonalFactor * (10 - lat * 0.1));
                });
                
                // Generate random rainfall data
                // Using longitude to simulate different climate patterns
                const lng = location.lng();
                const isWesternHemisphere = lng < 0;
                
                const rainfall = months.map((_, index) => {
                    let seasonalFactor;
                    
                    if (isWesternHemisphere) {
                        // Western hemisphere seasonal patterns
                        if (lat > 0) {
                            // Northern hemisphere
                            seasonalFactor = Math.cos((index / 12) * 2 * Math.PI);
                        } else {
                            // Southern hemisphere
                            seasonalFactor = -Math.cos((index / 12) * 2 * Math.PI);
                        }
                    } else {
                        // Eastern hemisphere seasonal patterns
                        if (lat > 0) {
                            // Northern hemisphere
                            seasonalFactor = Math.sin((index / 12) * 2 * Math.PI);
                        } else {
                            // Southern hemisphere
                            seasonalFactor = -Math.sin((index / 12) * 2 * Math.PI);
                        }
                    }
                    
                    return Math.max(5, Math.round(50 + seasonalFactor * 30 + Math.random() * 20));
                });
                
                // Update chart
                if (climateChart) {
                    climateChart.destroy();
                }
                
                const ctx = document.getElementById('climate-chart').getContext('2d');
                
                climateChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'High Temp (°C)',
                                data: highTemps,
                                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                type: 'line',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Low Temp (°C)',
                                data: lowTemps,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                type: 'line',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Rainfall (mm)',
                                data: rainfall,
                                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Rainfall (mm)'
                                }
                            }
                        }
                    }
                });
                
                // Update summary data
                const totalRainfall = rainfall.reduce((sum, val) => sum + val, 0);
                document.getElementById('avg-rainfall').textContent = `${Math.round(totalRainfall)} mm/year`;
                
                const minTemp = Math.min(...lowTemps);
                const maxTemp = Math.max(...highTemps);
                document.getElementById('temp-range').textContent = `${minTemp}°C to ${maxTemp}°C`;
                
                console.log('Climate data updated successfully');
            } catch (error) {
                console.error('Error updating climate data:', error);
            }
        }
        
        // Function to update sun path
        function updateSunPath(location, dateCode) {
            try {
                console.log('Updating sun path');
                const sunpathDiagram = document.getElementById('sunpath-diagram');
                
                // Make sure we have correct dimensions
                sunpathDiagram.width = sunpathDiagram.offsetWidth;
                sunpathDiagram.height = sunpathDiagram.offsetHeight;
                
                const ctx = sunpathDiagram.getContext('2d');
                
                // Clear the canvas
                ctx.clearRect(0, 0, sunpathDiagram.width, sunpathDiagram.height);
                
                // Set up the diagram
                const width = sunpathDiagram.width;
                const height = sunpathDiagram.height;
                const centerX = width / 2;
                const centerY = height * 0.7; // Lower the horizon to show more sky
                const radius = Math.min(width, height) * 0.4;
                
                // Draw horizon line
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(width, centerY);
                ctx.strokeStyle = isDarkMode() ? '#666' : '#aaa';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Draw compass points
                const compassPoints = [
                    { label: 'N', angle: 0 },
                    { label: 'E', angle: Math.PI * 0.5 },
                    { label: 'S', angle: Math.PI },
                    { label: 'W', angle: Math.PI * 1.5 }
                ];
                
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = isDarkMode() ? '#ddd' : '#333';
                
                compassPoints.forEach(point => {
                    const x = centerX + Math.sin(point.angle) * (radius + 20);
                    const y = centerY - Math.cos(point.angle) * (radius + 20);
                    ctx.fillText(point.label, x, y);
                });
                
                // Calculate sun path for the selected date
                let season = 'winter';
                if (dateCode === '0321' || dateCode === '0921') {
                    season = 'equinox';
                } else if (dateCode === '0621') {
                    season = 'summer';
                }
                
                // Adjust path based on latitude
                const latitude = location.lat();
                const isNorthernHemisphere = latitude >= 0;
                let maxAltitude;
                
                if (season === 'winter') {
                    maxAltitude = Math.max(0.1, 0.5 - Math.abs(latitude) / 90);
                    if (!isNorthernHemisphere) maxAltitude = 0.8 - maxAltitude;
                } else if (season === 'equinox') {
                    maxAltitude = 0.5;
                } else { // summer
                    maxAltitude = Math.min(0.9, 0.5 + Math.abs(latitude) / 90);
                    if (!isNorthernHemisphere) maxAltitude = 0.8 - maxAltitude;
                }
                
                // Draw sun path arc
                ctx.beginPath();
                
                // Create an arc from east to west
                // We'll simulate the sun path as a half-circle, adjusted for season and latitude
                ctx.moveTo(centerX - radius, centerY); // Starting at the west point
                
                // Draw the sun path
                for (let angle = -Math.PI; angle <= 0; angle += 0.01) {
                    const x = centerX + Math.sin(angle) * radius;
                    const y = centerY - Math.cos(angle) * radius * maxAltitude;
                    
                    if (angle === -Math.PI) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.strokeStyle = isDarkMode() ? '#ffa500' : '#ff6600';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Draw sun positions at different times
                const sunPositions = [
                    { time: 'Sunrise', angle: -Math.PI },
                    { time: '10:00', angle: -Math.PI * 0.75 },
                    { time: 'Noon', angle: -Math.PI * 0.5 },
                    { time: '15:00', angle: -Math.PI * 0.25 },
                    { time: 'Sunset', angle: 0 }
                ];
                
                sunPositions.forEach(pos => {
                    const x = centerX + Math.sin(pos.angle) * radius;
                    const y = centerY - Math.cos(pos.angle) * radius * maxAltitude;
                    
                    // Draw sun
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2);
                    ctx.fillStyle = isDarkMode() ? '#ffcc00' : '#ffaa00';
                    ctx.fill();
                    
                    // Draw time label
                    ctx.fillStyle = isDarkMode() ? '#ddd' : '#333';
                    ctx.fillText(pos.time, x, y + 20);
                });
                
                console.log('Sun path updated successfully');
            } catch (error) {
                console.error('Error updating sun path:', error);
            }
        }
        
        // Helper function to check if dark mode is active
        function isDarkMode() {
            return document.documentElement.classList.contains('dark');
        }
        
        // Check if Google Maps API is loaded, then initialize
        function initializeApp() {
            console.log('Checking if Google Maps API is loaded');
            try {
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    console.log('Google Maps API not yet loaded, waiting...');
                    setTimeout(initializeApp, 1000);
                    return;
                }
                
                console.log('Google Maps API loaded, initializing app');
                initMap();
            } catch (error) {
                console.error('Error checking Google Maps API:', error);
                document.getElementById('loading-indicator').classList.add('hidden');
                alert('Error loading Google Maps. Please refresh the page.');
            }
        }
        
        // Initialize the
